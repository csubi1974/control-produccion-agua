<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico PWA</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-item {
            background: white;
            margin: 10px 0;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #ddd;
        }
        .success {
            border-left-color: #4CAF50;
            background: #f8fff8;
        }
        .error {
            border-left-color: #f44336;
            background: #fff8f8;
        }
        .warning {
            border-left-color: #ff9800;
            background: #fffaf0;
        }
        .status {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .details {
            font-size: 14px;
            color: #666;
        }
        button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #1976D2;
        }
        #installButton {
            background: #4CAF50;
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            border-radius: 50px;
            padding: 15px 20px;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }
    </style>
</head>
<body>
    <h1>üîç Diagn√≥stico PWA - Control Producci√≥n Agua</h1>
    
    <div id="diagnosticos"></div>
    
    <button onclick="ejecutarDiagnostico()">üîÑ Ejecutar Diagn√≥stico</button>
    <button onclick="forzarInstalacion()">üì± Forzar Instalaci√≥n</button>
    <button onclick="limpiarCache()">üóëÔ∏è Limpiar Cache</button>
    
    <script>
        let deferredPrompt;
        const diagnosticos = document.getElementById('diagnosticos');
        
        function agregarTest(titulo, estado, detalles) {
            const div = document.createElement('div');
            div.className = `test-item ${estado}`;
            div.innerHTML = `
                <div class="status">${titulo}</div>
                <div class="details">${detalles}</div>
            `;
            diagnosticos.appendChild(div);
        }
        
        async function ejecutarDiagnostico() {
            diagnosticos.innerHTML = '';
            
            // 1. Verificar HTTPS
            const isHTTPS = location.protocol === 'https:' || location.hostname === 'localhost';
            agregarTest(
                isHTTPS ? '‚úÖ HTTPS/Localhost' : '‚ùå HTTPS/Localhost',
                isHTTPS ? 'success' : 'error',
                isHTTPS ? 'Protocolo seguro detectado' : 'Se requiere HTTPS o localhost para PWA'
            );
            
            // 2. Verificar Service Worker
            const swSupported = 'serviceWorker' in navigator;
            agregarTest(
                swSupported ? '‚úÖ Service Worker Soportado' : '‚ùå Service Worker No Soportado',
                swSupported ? 'success' : 'error',
                swSupported ? 'El navegador soporta Service Workers' : 'Service Workers no disponibles'
            );
            
            // 3. Verificar registro de SW
            if (swSupported) {
                try {
                    const registration = await navigator.serviceWorker.getRegistration();
                    agregarTest(
                        registration ? '‚úÖ Service Worker Registrado' : '‚ö†Ô∏è Service Worker No Registrado',
                        registration ? 'success' : 'warning',
                        registration ? `Scope: ${registration.scope}` : 'No se encontr√≥ registro de SW'
                    );
                } catch (error) {
                    agregarTest(
                        '‚ùå Error al verificar Service Worker',
                        'error',
                        error.message
                    );
                }
            }
            
            // 4. Verificar Manifest
            try {
                const response = await fetch('/manifest.json');
                const manifest = await response.json();
                agregarTest(
                    '‚úÖ Manifest Accesible',
                    'success',
                    `Nombre: ${manifest.name}, Display: ${manifest.display}`
                );
            } catch (error) {
                agregarTest(
                    '‚ùå Error al cargar Manifest',
                    'error',
                    error.message
                );
            }
            
            // 5. Verificar beforeinstallprompt
            agregarTest(
                deferredPrompt ? '‚úÖ Prompt de Instalaci√≥n Disponible' : '‚ö†Ô∏è Prompt de Instalaci√≥n No Disponible',
                deferredPrompt ? 'success' : 'warning',
                deferredPrompt ? 'El evento beforeinstallprompt se ha disparado' : 'Esperando evento beforeinstallprompt o ya instalada'
            );
            
            // 6. Verificar si ya est√° instalada
            const isPWA = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
            agregarTest(
                isPWA ? '‚úÖ PWA Ya Instalada' : '‚ö†Ô∏è PWA No Instalada',
                isPWA ? 'success' : 'warning',
                isPWA ? 'La aplicaci√≥n se est√° ejecutando como PWA' : 'La aplicaci√≥n se est√° ejecutando en navegador'
            );
            
            // 7. Verificar iconos
            const iconos = ['icon-192.png', 'icon-512.png'];
            for (const icono of iconos) {
                try {
                    const response = await fetch(`/${icono}`);
                    agregarTest(
                        response.ok ? `‚úÖ Icono ${icono}` : `‚ùå Icono ${icono}`,
                        response.ok ? 'success' : 'error',
                        response.ok ? 'Icono accesible' : 'Icono no encontrado'
                    );
                } catch (error) {
                    agregarTest(
                        `‚ùå Error al verificar ${icono}`,
                        'error',
                        error.message
                    );
                }
            }
            
            // 8. Informaci√≥n del navegador
            agregarTest(
                'üìä Informaci√≥n del Navegador',
                'success',
                `${navigator.userAgent.split(' ').slice(-2).join(' ')}`
            );
        }
        
        function forzarInstalacion() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    console.log('Resultado:', choiceResult.outcome);
                    deferredPrompt = null;
                });
            } else {
                alert('‚ùå No hay prompt de instalaci√≥n disponible.\n\nPosibles razones:\n‚Ä¢ La PWA ya est√° instalada\n‚Ä¢ El navegador a√∫n no ha detectado la PWA\n‚Ä¢ Faltan requisitos de instalabilidad');
            }
        }
        
        async function limpiarCache() {
            if ('caches' in window) {
                const cacheNames = await caches.keys();
                await Promise.all(
                    cacheNames.map(cacheName => caches.delete(cacheName))
                );
                alert('‚úÖ Cache limpiado. Recarga la p√°gina.');
            }
        }
        
        // Detectar evento beforeinstallprompt
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Mostrar bot√≥n de instalaci√≥n
            if (!document.getElementById('installButton')) {
                const installButton = document.createElement('button');
                installButton.id = 'installButton';
                installButton.innerHTML = 'üì± Instalar PWA';
                installButton.onclick = forzarInstalacion;
                document.body.appendChild(installButton);
            }
            
            console.log('‚úÖ Evento beforeinstallprompt detectado');
        });
        
        // Detectar instalaci√≥n
        window.addEventListener('appinstalled', (evt) => {
            console.log('‚úÖ PWA instalada exitosamente');
            const installButton = document.getElementById('installButton');
            if (installButton) {
                installButton.remove();
            }
        });
        
        // Registrar Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    await navigator.serviceWorker.register('/sw.js');
                    console.log('‚úÖ Service Worker registrado');
                } catch (error) {
                    console.error('‚ùå Error al registrar SW:', error);
                }
            });
        }
        
        // Ejecutar diagn√≥stico autom√°ticamente
        window.addEventListener('load', () => {
            setTimeout(ejecutarDiagnostico, 1000);
        });
    </script>
</body>
</html>